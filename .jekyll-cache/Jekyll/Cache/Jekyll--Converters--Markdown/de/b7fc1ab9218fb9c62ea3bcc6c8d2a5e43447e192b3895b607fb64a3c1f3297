I"ó<h2 id="explicaci√≥n-te√≥rica">Explicaci√≥n te√≥rica</h2>

<p>Supongamos que hemos vulnerado una m√°quina Windows y que tenemos una shell de usuario raso.</p>

<p>Decididmos estudiar los posibles m√©todos de escalada de privilegios haciendo uso de <a href="https://github.com/BloodHoundAD/BloodHound">Bloodhound</a> para enumerar el dominio, sus objetos y propiedades.</p>

<p>Descubrimos que existe una GPO que podemos modificar porque tenemos permiso de escritura sobre ella. Veremos como hacerlo para incluir a nuestro usuario en el grupo de administradores.</p>

<h2 id="caso-pr√°ctico">Caso pr√°ctico</h2>

<p>Como ya hemos dicho, mediante el ingestor adecuado, obtenemos el zip con la informaci√≥n que importaremos en Bloodhound. Tras utilizar una query predefinida para obtener el camino m√°s corto hacia el Domain Admin, obtenemos:</p>

<p><img src="../img/GPOAbuse/vulnnet0.png" alt="" /></p>

<p>Es decir, la cuenta con la que hemos obtenido acceso a la m√°quina, <em><code class="language-plaintext highlighter-rouge">enterprise-security</code></em>, tiene permisos de escritura sobre la GPO <em><code class="language-plaintext highlighter-rouge">security-pol-vn</code></em>, dentro del dominio <em><code class="language-plaintext highlighter-rouge">vulnnet.local</code></em>, que contiene al usuario <em><code class="language-plaintext highlighter-rouge">Administrator</code></em> y al grupo <em><code class="language-plaintext highlighter-rouge">Administrators</code></em></p>

<p>Es decir, debemos hacer uso de esta GPO o ‚Äúabusar‚Äù de ella mediante la herramienta adecuada. Para este cometido tentemos <a href="https://github.com/FSecureLABS/SharpGPOAbuse">SharpGPOAbuse</a>. En teor√≠a, es necesario compilar el c√≥digo de esta aplicaci√≥n para obtener el ejecutable:</p>

<p><code class="language-plaintext highlighter-rouge">SharpGPOAbuse has been built against .NET 3.5 and is compatible with Visual Studio 2017.</code></p>

<p>No obstante, es posible encontrar alguna versi√≥n precompilada, como por ejemplo <a href="https://github.com/byronkg/SharpGPOAbuse">aqu√≠</a></p>

<h3 id="transferencia-de-sharpgpoabuseexe-a-la-m√°qjuina-v√≠ctima">Transferencia de SharpGPOAbuse.exe a la m√°qjuina v√≠ctima</h3>

<p>Tras obtener nuestra shell inversa mediante cualquier m√©todo, procederemos a transmitir este ejecutable desde nuestra m√°quina atacante a nuestra m√°quina v√≠ctima.</p>

<p>Tras ello, se comprueba la informaci√≥n de la cuenta de usuario comprometida:</p>

<p><img src="../img/GPOAbuse/vulnnet.png" alt="" /></p>

<p>Notar que el usuario s√≥lo pertenece al grupo de usuarios de dominio (Domain Users)</p>

<h3 id="uso-y-sintaxis-de-sharpgpoabuseexe">Uso y sintaxis de SharpGPOAbuse.exe</h3>

<p>Siguiendo la sintaxis que se nos indica en su github, hacemos uso de esta aplicaci√≥n para a√±adir una nueva tarea al dominio, ejecutada por el administrador y que consiste en a√±adir el usuario omprometido al grupo de administradores mediante la GPO susceptible de ser abusada.</p>

<p><img src="../img/GPOAbuse/vulnnet2.png" alt="" /></p>

<p>Tambi√©n forzamos la actualizaci√≥n de las pol√≠ticas.</p>

<p>Y si comprobamos ahora la informaci√≥n de la cuenta de usuario, vemos que pertenecemos al grupo <code class="language-plaintext highlighter-rouge">Administrators</code>, ergo somos administradores del dominio.</p>

<p><img src="../img/GPOAbuse/vulnnet3.png" alt="" /></p>

<p>Por lo que podemos conectarnos de forma remota con este usuario y con <code class="language-plaintext highlighter-rouge">psexec</code> y comprobar que, efectivamente, nuestra cuenta es <code class="language-plaintext highlighter-rouge">nt authority\system</code></p>

<p><img src="../img/GPOAbuse/vulnnet4.png" alt="" /></p>
:ET